<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team - Game Show</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #da251d 0%, #c41e1a 100%);
            color: #FFD700;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        h1 {
            text-align: center;
            font-size: 2.5rem;
            margin-bottom: 30px;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.7);
            color: #FFD700;
        }

        .star {
            color: #FFD700;
            font-size: 2rem;
            margin: 0 10px;
        }

        .scoreboard {
            margin-bottom: 20px;
        }

        .team-score {
            background: rgba(0, 0, 0, 0.5);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            border: 3px solid #FFD700;
        }

        .team-score h2 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .score {
            font-size: 3rem;
            font-weight: bold;
            color: #FFD700;
        }

        h2 {
            text-align: center;
            margin-bottom: 20px;
            color: #FFD700;
        }

        .team-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 30px;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }

        .question-cell {
            aspect-ratio: 1;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            border: 3px solid #FFD700;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: #da251d;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .question-cell:hover:not(.answered) {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(255, 215, 0, 0.6);
        }

        .question-cell.answered {
            cursor: not-allowed;
            position: relative;
            overflow: hidden;
        }

        .question-cell.answered::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                45deg,
                rgba(255, 255, 255, 0) 0%,
                rgba(255, 255, 255, 0.3) 50%,
                rgba(255, 255, 255, 0) 100%
            );
            animation: shine 2s infinite;
        }

        @keyframes shine {
            0% {
                transform: translateX(-100%) translateY(-100%);
            }
            100% {
                transform: translateX(100%) translateY(100%);
            }
        }

        .question-cell.team-a {
            background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%);
            border: 4px solid #ff0000;
            color: #fff;
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.6),
                        inset 0 0 20px rgba(255, 100, 100, 0.3);
            animation: glow-red 2s ease-in-out infinite;
        }

        @keyframes glow-red {
            0%, 100% {
                box-shadow: 0 0 20px rgba(255, 0, 0, 0.6),
                           inset 0 0 20px rgba(255, 100, 100, 0.3);
            }
            50% {
                box-shadow: 0 0 30px rgba(255, 0, 0, 0.9),
                           inset 0 0 30px rgba(255, 100, 100, 0.5);
            }
        }

        .question-cell.team-b {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            border: 4px solid #FFD700;
            color: #da251d;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.6),
                        inset 0 0 20px rgba(255, 215, 0, 0.3);
            animation: glow-yellow 2s ease-in-out infinite;
        }

        @keyframes glow-yellow {
            0%, 100% {
                box-shadow: 0 0 20px rgba(255, 215, 0, 0.6),
                           inset 0 0 20px rgba(255, 215, 0, 0.3);
            }
            50% {
                box-shadow: 0 0 30px rgba(255, 215, 0, 0.9),
                           inset 0 0 30px rgba(255, 215, 0, 0.5);
            }
        }

        .question-cell.dead {
            background: rgba(100, 100, 100, 0.5);
            border: 3px solid #666;
            color: #999;
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.7);
        }

        .status {
            text-align: center;
            margin: 20px 0;
            font-size: 1.2rem;
            min-height: 50px;
        }

        .back-btn {
            display: block;
            margin: 20px auto 0;
            padding: 12px 30px;
            font-size: 1rem;
            font-weight: bold;
            background: rgba(255, 255, 255, 0.2);
            color: #FFD700;
            border: 2px solid #FFD700;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        /* Question Modal for Team */
        .question-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .question-modal.show {
            display: flex;
        }

        .question-content {
            background: linear-gradient(135deg, #da251d 0%, #c41e1a 100%);
            border: 5px solid #FFD700;
            border-radius: 20px;
            padding: 40px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .question-header {
            font-size: 1.8rem;
            color: #FFD700;
            margin-bottom: 30px;
            text-align: center;
            font-weight: bold;
        }

        .timer-display {
            font-size: 3rem;
            color: #FFD700;
            text-align: center;
            margin: 20px 0;
            font-weight: bold;
        }

        .timer-display.warning {
            color: #ff6666;
            animation: pulse 0.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .question-text {
            font-size: 1.4rem;
            color: #FFD700;
            margin-bottom: 30px;
            line-height: 1.6;
            text-align: left;
        }

        .answer-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 30px;
        }

        .answer-option {
            padding: 20px;
            font-size: 1.2rem;
            background: rgba(255, 215, 0, 0.2);
            color: #FFD700;
            border: 3px solid #FFD700;
            border-radius: 10px;
            text-align: left;
        }

        .waiting-message {
            text-align: center;
            font-size: 1.3rem;
            color: #FFD700;
            padding: 20px;
        }

        /* Round 2 Modal for Team */
        .round2-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 3000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .round2-modal.show {
            display: flex;
        }

        .round2-content {
            background: linear-gradient(135deg, #da251d 0%, #c41e1a 100%);
            border: 5px solid #FFD700;
            border-radius: 20px;
            padding: 40px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .round2-question {
            font-size: 1.6rem;
            color: #FFD700;
            line-height: 1.8;
            margin-bottom: 30px;
            text-align: left;
        }

        /* Bingo Modal */
        .bingo-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 4000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .bingo-modal.show {
            display: flex;
        }

        .bingo-content {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            border: 8px solid #fff;
            border-radius: 30px;
            padding: 60px;
            text-align: center;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.8);
            animation: bingoPopup 0.5s ease-out;
        }

        @keyframes bingoPopup {
            0% {
                transform: scale(0.5) rotate(-5deg);
                opacity: 0;
            }
            100% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        .bingo-title {
            font-size: 5rem;
            color: #da251d;
            font-weight: bold;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.3);
            margin-bottom: 20px;
            animation: bingoShake 0.5s ease-in-out infinite;
        }

        @keyframes bingoShake {
            0%, 100% { transform: rotate(-3deg); }
            50% { transform: rotate(3deg); }
        }

        .bingo-message {
            font-size: 2rem;
            color: #da251d;
            margin-top: 20px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>
            <span class="star">‚òÖ</span>
            <span id="teamTitle">TEAM</span>
            <span class="star">‚òÖ</span>
        </h1>
        
        <div class="scoreboard">
            <div class="team-score">
                <h2>ƒêi·ªÉm c·ªßa b·∫°n</h2>
                <div class="score" id="teamScore">0</div>
            </div>
        </div>

        <h2>Ch·ªçn √¥ c√¢u h·ªèi</h2>
        
        <div class="team-grid">
            <div class="question-cell" data-cell="1">1</div>
            <div class="question-cell" data-cell="2">2</div>
            <div class="question-cell" data-cell="3">3</div>
            <div class="question-cell" data-cell="4">4</div>
            <div class="question-cell" data-cell="5">5</div>
            <div class="question-cell" data-cell="6">6</div>
            <div class="question-cell" data-cell="7">7</div>
            <div class="question-cell" data-cell="8">8</div>
            <div class="question-cell" data-cell="9">9</div>
        </div>

        <div class="status" id="status">Ch·ªçn m·ªôt √¥ ƒë·ªÉ tr·∫£ l·ªùi c√¢u h·ªèi</div>

        <button class="back-btn" onclick="backToMain()">üè† Quay l·∫°i m√†n h√¨nh ch√≠nh</button>
    </div>

    <!-- Question Modal -->
    <div id="questionModal" class="question-modal">
        <div class="question-content">
            <div class="question-header" id="questionHeader">C√¢u h·ªèi</div>
            <div class="timer-display" id="timerDisplay"></div>
            <div class="question-text" id="questionText"></div>
            <div class="answer-options" id="answerOptions"></div>
            <div class="waiting-message" id="waitingMessage">
                ‚è≥ ƒêang ch·ªù Host ch·∫•m ƒëi·ªÉm...
            </div>
        </div>
    </div>

    <!-- Round 2 Modal -->
    <div id="round2Modal" class="round2-modal">
        <div class="round2-content">
            <h1 style="text-align: center; color: #FFD700; margin-bottom: 30px;">
                ‚≠ê V√íNG 2 - C√ÇU H·ªéI M·ªû ‚≠ê
            </h1>
            <div class="round2-question">
                <p style="margin-bottom: 20px;">
                    <strong>C√¢u h·ªèi:</strong> H·ªì Ch√≠ Minh t·ª´ng kh·∫≥ng ƒë·ªãnh: <em>"VƒÉn h√≥a ·ªü trong ch√≠nh tr·ªã v√† kinh t·∫ø"</em>. 
                    Tuy nhi√™n, Ng∆∞·ªùi c≈©ng quan ni·ªám: <em>"Mu·ªën ti·∫øn l√™n ch·ªß nghƒ©a x√£ h·ªôi th√¨ ph·∫£i ph√°t tri·ªÉn kinh t·∫ø v√† vƒÉn h√≥a. 
                    T·ª•c ng·ªØ ta c√≥ c√¢u: C√≥ th·ª±c m·ªõi v·ª±c ƒë∆∞·ª£c ƒë·∫°o, v√¨ th·∫ø kinh t·∫ø ph·∫£i ƒëi tr∆∞·ªõc".</em>
                </p>
                <p style="margin-bottom: 20px;">
                    H√£y ph√¢n t√≠ch <strong>m·ªëi quan h·ªá bi·ªán ch·ª©ng gi·ªØa VƒÉn h√≥a v·ªõi Kinh t·∫ø v√† Ch√≠nh tr·ªã</strong> theo t∆∞ t∆∞·ªüng H·ªì Ch√≠ Minh.
                </p>
                <p>
                    T·∫°i sao Ng∆∞·ªùi cho r·∫±ng <strong>kinh t·∫ø, ch√≠nh tr·ªã ph·∫£i ƒëi tr∆∞·ªõc m·ªü ƒë∆∞·ªùng</strong>, nh∆∞ng vƒÉn h√≥a l·∫°i kh√¥ng ƒë∆∞·ª£c 
                    <em>"ƒë·ª©ng ngo√†i"</em> m√† ph·∫£i ·ªü <em>"trong"</em> kinh t·∫ø v√† ch√≠nh tr·ªã?
                </p>
            </div>
            <div style="text-align: center; margin-top: 30px; color: #FFD700; font-size: 1.3rem;">
                üí° H√£y th·∫£o lu·∫≠n nh√≥m v√† chu·∫©n b·ªã tr·∫£ l·ªùi mi·ªáng!
            </div>
        </div>
    </div>

    <!-- Bingo Modal -->
    <div id="bingoModal" class="bingo-modal">
        <div class="bingo-content">
            <div class="bingo-title">üéâ BINGO! üéâ</div>
            <div class="bingo-message" id="bingoMessage">Ch√∫c m·ª´ng b·∫°n ƒë√£ th·∫Øng!</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getDatabase, ref, set, onValue, update, get } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBVnhRlz7goa18Y0Uwb6E3yJuTEBvxWEgY",
            authDomain: "tu-tuong-hcm-game.firebaseapp.com",
            databaseURL: "https://tu-tuong-hcm-game-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "tu-tuong-hcm-game",
            storageBucket: "tu-tuong-hcm-game.firebasestorage.app",
            messagingSenderId: "637672671853",
            appId: "1:637672671853:web:b6396983c7878376b1cd64",
            measurementId: "G-WLRF1W52DH"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Questions Database
        const questions = [
            {
                id: 1,
                question: "V√†o th√°ng 8/1943, khi c√≤n trong nh√† t√π c·ªßa T∆∞·ªüng Gi·ªõi Th·∫°ch, H·ªì Ch√≠ Minh ƒë√£ ƒë∆∞a ra quan ni·ªám v·ªÅ lƒ©nh v·ª±c n√†o sau ƒë√¢y?",
                answers: ["A. Kinh t·∫ø", "B. Ch√≠nh tr·ªã", "C. VƒÉn h√≥a", "D. Ngo·∫°i giao"],
                correct: "C"
            },
            {
                id: 2,
                question: "Theo H·ªì Ch√≠ Minh, m·ªëi quan h·ªá gi·ªØa vƒÉn h√≥a v·ªõi kinh t·∫ø v√† ch√≠nh tr·ªã ƒë∆∞·ª£c x√°c ƒë·ªãnh nh∆∞ th·∫ø n√†o?",
                answers: ["A. VƒÉn h√≥a n·∫±m ngo√†i kinh t·∫ø v√† ch√≠nh tr·ªã", "B. VƒÉn h√≥a ·ªü trong kinh t·∫ø v√† ch√≠nh tr·ªã", "C. VƒÉn h√≥a ƒë·ª©ng tr√™n kinh t·∫ø v√† ch√≠nh tr·ªã", "D. VƒÉn h√≥a kh√¥ng li√™n quan ƒë·∫øn kinh t·∫ø"],
                correct: "B"
            },
            {
                id: 3,
                question: 'Trong quan ƒëi·ªÉm c·ªßa H·ªì Ch√≠ Minh v·ªÅ vai tr√≤ c·ªßa vƒÉn h√≥a, Ng∆∞·ªùi ƒë√£ kh·∫≥ng ƒë·ªãnh: "VƒÉn h√≥a ngh·ªá thu·∫≠t c≈©ng l√† m·ªôt..."?',
                answers: ["A. Tr√≤ ch∆°i gi·∫£i tr√≠", "B. C√¥ng c·ª• tuy√™n truy·ªÅn", "C. M·∫∑t tr·∫≠n", "D. H√¨nh th·ª©c kinh doanh"],
                correct: "C"
            },
            {
                id: 4,
                question: "H·ªì Ch√≠ Minh v√≠ ƒë·∫°o ƒë·ª©c c√°ch m·∫°ng nh∆∞ y·∫øu t·ªë n√†o c·ªßa c√¢y v√† s√¥ng?",
                answers: ["A. C√†nh v√† nh√°nh", "B. Hoa v√† l√°", "C. G·ªëc v√† ngu·ªìn", "D. Th√¢n v√† d√≤ng ch·∫£y"],
                correct: "C"
            },
            {
                id: 5,
                question: "Trong c√°c ph·∫©m ch·∫•t ƒë·∫°o ƒë·ª©c c√°ch m·∫°ng, ph·∫©m ch·∫•t n√†o ƒë∆∞·ª£c H·ªì Ch√≠ Minh coi l√† quan tr·ªçng nh·∫•t, bao tr√πm nh·∫•t?",
                answers: ["A. C·∫ßn, ki·ªám, li√™m, ch√≠nh", "B. Trung v·ªõi n∆∞·ªõc, hi·∫øu v·ªõi d√¢n", "C. Y√™u th∆∞∆°ng con ng∆∞·ªùi", "D. Tinh th·∫ßn qu·ªëc t·∫ø trong s√°ng"],
                correct: "B"
            },
            {
                id: 6,
                question: 'Theo H·ªì Ch√≠ Minh, ch·ªØ "Li√™m" trong "C·∫ßn, ki·ªám, li√™m, ch√≠nh" c√≥ nghƒ©a l√† g√¨?',
                answers: ["A. Si√™ng nƒÉng, chƒÉm ch·ªâ", "B. Ti·∫øt ki·ªám, kh√¥ng hoang ph√≠", "C. Trong s·∫°ch, kh√¥ng tham lam", "D. Th·∫≥ng th·∫Øn, ƒë·ª©ng ƒë·∫Øn"],
                correct: "C"
            },
            {
                id: 7,
                question: '"M·ªôt t·∫•m g∆∞∆°ng s·ªëng c√≤n c√≥ gi√° tr·ªã h∆°n m·ªôt trƒÉm b√†i di·ªÖn vƒÉn tuy√™n truy·ªÅn" th·ªÉ hi·ªán nguy√™n t·∫Øc x√¢y d·ª±ng ƒë·∫°o ƒë·ª©c n√†o c·ªßa H·ªì Ch√≠ Minh?',
                answers: ["A. N√≥i ƒëi ƒë√¥i v·ªõi l√†m, n√™u g∆∞∆°ng v·ªÅ ƒë·∫°o ƒë·ª©c", "B. X√¢y ƒëi ƒë√¥i v·ªõi ch·ªëng", "C. Tu d∆∞·ª°ng ƒë·∫°o ƒë·ª©c su·ªët ƒë·ªùi", "D. Ph√™ b√¨nh v√† t·ª± ph√™ b√¨nh"],
                correct: "A"
            },
            {
                id: 8,
                question: 'ƒêi·ªÅn v√†o ch·ªó tr·ªëng c√¢u n√≥i n·ªïi ti·∫øng c·ªßa B√°c: "V√¨ l·ª£i √≠ch m∆∞·ªùi nƒÉm th√¨ ph·∫£i tr·ªìng c√¢y, v√¨ l·ª£i √≠ch trƒÉm nƒÉm th√¨ ph·∫£i ..."?',
                answers: ["A. Tr·ªìng ng∆∞·ªùi", "B. X√¢y tr∆∞·ªùng h·ªçc", "C. Ph√°t tri·ªÉn kinh t·∫ø", "D. Gi·ªØ n∆∞·ªõc"],
                correct: "A"
            },
            {
                id: 9,
                question: "H·ªì Ch√≠ Minh x√°c ƒë·ªãnh con ng∆∞·ªùi v·ª´a l√† m·ª•c ti√™u, v·ª´a l√† ... c·ªßa c√°ch m·∫°ng?",
                answers: ["A. C√¥ng c·ª•", "B. ƒê·ªông l·ª±c", "C. Kh√°ch th·ªÉ", "D. K·∫øt qu·∫£"],
                correct: "B"
            }
        ];

        // Get team from URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const team = urlParams.get('team'); // 'A' or 'B'

        let questionTimer = null;
        let timeLeft = 30;

        if (!team || (team !== 'A' && team !== 'B')) {
            alert('Invalid team parameter!');
            window.location.href = './index_new.html';
        }

        // Set team title
        const teamEmoji = team === 'A' ? 'üî¥' : 'üü°';
        const teamColor = team === 'A' ? 'ƒê·ªé' : 'V√ÄNG';
        document.getElementById('teamTitle').textContent = `TEAM ${team} (${teamColor})`;

        // Listen to game state for scores
        const gameStateRef = ref(database, 'gameState');
        onValue(gameStateRef, (snapshot) => {
            const data = snapshot.val();
            if (data) {
                document.getElementById('teamScore').textContent = data.scores[team];
            }
        });

        // Listen to cells state
        const cellsRef = ref(database, 'cells');
        onValue(cellsRef, (snapshot) => {
            const cells = snapshot.val();
            if (cells) {
                updateTeamGrid(cells);
            }
        });

        // Listen to Round 2 status
        const round2Ref = ref(database, 'round2Status');
        onValue(round2Ref, (snapshot) => {
            const status = snapshot.val();
            console.log('Round 2 status:', status);
            if (status && status.active) {
                console.log('Showing Round 2 modal');
                document.getElementById('round2Modal').classList.add('show');
            } else {
                document.getElementById('round2Modal').classList.remove('show');
            }
        });

        // Listen to bingo status
        const bingoRef = ref(database, 'bingoStatus');
        onValue(bingoRef, (snapshot) => {
            const status = snapshot.val();
            console.log('Bingo status:', status);
            if (status && status.active) {
                const message = status.winner === `Team ${team}` ? 
                    `üéä Team ${team} TH·∫ÆNG! üéä` : 
                    `Team ${status.winner} ƒë√£ th·∫Øng!`;
                document.getElementById('bingoMessage').textContent = message;
                document.getElementById('bingoModal').classList.add('show');
            } else {
                document.getElementById('bingoModal').classList.remove('show');
            }
        });

        // Listen to cell selection status
        const cellSelectionRef = ref(database, 'cellSelection');
        onValue(cellSelectionRef, (snapshot) => {
            const selection = snapshot.val();
            const status = document.getElementById('status');
            console.log('Cell selection update:', selection);
            console.log('Current team:', team);
            
            // Check if this team is answering and status is approved
            if (selection && selection.status === 'approved' && selection.answeringTeam === `Team ${team}`) {
                // Show question only if this team is the one who will answer
                console.log('Approved! Showing question modal for cell:', selection.cellNumber);
                status.textContent = `‚úÖ ƒê√£ ƒë∆∞·ª£c duy·ªát! ƒêang hi·ªÉn th·ªã c√¢u h·ªèi...`;
                status.style.color = '#00ff00';
                showQuestionModal(selection.cellNumber);
            } else if (selection && selection.teamRequesting === `Team ${team}`) {
                if (selection.status === 'pending') {
                    status.textContent = `‚è≥ ƒêang ch·ªù Host ph√™ duy·ªát √¥ ${selection.cellNumber}...`;
                    status.style.color = '#FFD700';
                    closeQuestionModal();
                } else if (selection.status === 'rejected') {
                    status.textContent = `‚ùå B·ªã t·ª´ ch·ªëi. Ch·ªçn √¥ kh√°c!`;
                    status.style.color = '#ff6666';
                    closeQuestionModal();
                    
                    setTimeout(() => {
                        status.textContent = 'Ch·ªçn m·ªôt √¥ ƒë·ªÉ tr·∫£ l·ªùi c√¢u h·ªèi';
                        status.style.color = '#FFD700';
                    }, 3000);
                } else if (selection.status === 'approved' && selection.answeringTeam !== `Team ${team}`) {
                    // This team requested but host gave to other team
                    status.textContent = `‚ö†Ô∏è Host ƒë√£ cho ${selection.answeringTeam} tr·∫£ l·ªùi`;
                    status.style.color = '#ff6666';
                    closeQuestionModal();
                }
            } else if (selection && selection.teamRequesting && selection.teamRequesting !== `Team ${team}`) {
                status.textContent = `${selection.teamRequesting} ƒëang ch·ªçn √¥...`;
                status.style.color = '#ff6666';
                closeQuestionModal();
            } else {
                status.textContent = 'Ch·ªçn m·ªôt √¥ ƒë·ªÉ tr·∫£ l·ªùi c√¢u h·ªèi';
                status.style.color = '#FFD700';
                closeQuestionModal();
            }
        });

        function updateTeamGrid(cells) {
            const cellElements = document.querySelectorAll('.question-cell');
            
            cellElements.forEach(cell => {
                const cellNum = parseInt(cell.dataset.cell);
                const cellData = cells[cellNum];
                
                // Remove all state classes first
                cell.classList.remove('team-a', 'team-b', 'dead', 'answered');
                
                // Add appropriate classes based on cell owner
                if (cellData && cellData.owner) {
                    if (cellData.owner === 'A') {
                        cell.classList.add('team-a', 'answered');
                    } else if (cellData.owner === 'B') {
                        cell.classList.add('team-b', 'answered');
                    } else if (cellData.owner === 'dead') {
                        cell.classList.add('dead', 'answered');
                    }
                }
                // If owner is null or undefined, cell stays in default state (no classes added)
            });
        }

        // Add click handlers to cells
        document.querySelectorAll('.question-cell').forEach(cell => {
            cell.addEventListener('click', async () => {
                const cellNumber = parseInt(cell.dataset.cell);
                await selectCell(cellNumber);
            });
        });

        async function selectCell(cellNumber) {
            try {
                const cellsSnapshot = await get(cellsRef);
                const cells = cellsSnapshot.val();
                
                if (!cells || !cells[cellNumber]) {
                    alert('√î n√†y kh√¥ng h·ª£p l·ªá!');
                    return;
                }
                
                if (cells[cellNumber].answered) {
                    alert('√î n√†y ƒë√£ ƒë∆∞·ª£c tr·∫£ l·ªùi!');
                    return;
                }
                
                const selectionSnapshot = await get(cellSelectionRef);
                const currentSelection = selectionSnapshot.val();
                
                if (currentSelection && currentSelection.status === 'pending') {
                    alert('Vui l√≤ng ch·ªù Host ph√™ duy·ªát y√™u c·∫ßu hi·ªán t·∫°i!');
                    return;
                }
                
                await set(cellSelectionRef, {
                    teamRequesting: `Team ${team}`,
                    cellNumber: cellNumber,
                    status: 'pending',
                    currentQuestion: null,
                    answeringTeam: `Team ${team}`,
                    timestamp: Date.now()
                });
            } catch (error) {
                console.error('Error selecting cell:', error);
                alert('C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i!');
            }
        }

        function showQuestionModal(cellNumber) {
            console.log('showQuestionModal called with cellNumber:', cellNumber);
            const question = questions[cellNumber - 1];
            if (!question) {
                console.error('Question not found:', cellNumber);
                return;
            }
            console.log('Question found:', question);

            document.getElementById('questionHeader').textContent = `C√¢u h·ªèi #${cellNumber}`;
            document.getElementById('questionText').textContent = question.question;
            
            const optionsContainer = document.getElementById('answerOptions');
            optionsContainer.innerHTML = '';
            
            question.answers.forEach(answer => {
                const div = document.createElement('div');
                div.className = 'answer-option';
                div.textContent = answer;
                optionsContainer.appendChild(div);
            });
            
            // Clear previous timer
            if (questionTimer) {
                clearInterval(questionTimer);
                questionTimer = null;
            }
            
            // Start new timer
            timeLeft = 30;
            const timerDisplay = document.getElementById('timerDisplay');
            timerDisplay.textContent = `‚è±Ô∏è ${timeLeft}s`;
            timerDisplay.classList.remove('warning');
            
            questionTimer = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = `‚è±Ô∏è ${timeLeft}s`;
                if (timeLeft <= 10) {
                    timerDisplay.classList.add('warning');
                }
                if (timeLeft <= 0) {
                    clearInterval(questionTimer);
                    timerDisplay.textContent = '‚è∞ H·∫øt gi·ªù!';
                }
            }, 1000);
            
            const modal = document.getElementById('questionModal');
            console.log('Modal element:', modal);
            modal.classList.add('show');
            console.log('Modal classes after add:', modal.classList);
        }

        function closeQuestionModal() {
            if (questionTimer) {
                clearInterval(questionTimer);
                questionTimer = null;
            }
            document.getElementById('questionModal').classList.remove('show');
        }

        window.backToMain = function() {
            if (questionTimer) clearInterval(questionTimer);
            window.location.href = './index_new.html';
        };
    </script>
</body>
</html>
